<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MITM Command Center</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
<div class="container">
    <header class="topbar">
        <h1 class="title">MITM COMMAND CENTER</h1>
        <div class="status-display">
            <div id="status-dot" class="status-dot idle"></div>
            <span id="status-text" class="status-text idle">SYSTEM READY</span>
        </div>
    </header>

    <div class="grid">
        <div class="left-col">
            
            <div class="arp-header">
                <div>
                    <div style="color:#fff; font-weight:bold; font-size:15px;">Global Interception</div>
                    <div style="font-size:11px; color:#666;">Establishes Man-in-the-Middle position</div>
                </div>
                
                <div>
                    <button class="export-btn" onclick="window.location.href='/export'">
                        <span class="export-icon">↓</span> EXPORT
                    </button>
                </div>
            </div>

            <div class="tab-bar">
                <button class="tab-btn" onclick="switchTab('dns')">DNS Mode</button>
                <button class="tab-btn" onclick="switchTab('ssl')">SSL Strip</button>
                <button class="tab-btn" onclick="switchTab('silent')">Silent</button>
            </div>

            <div class="config-panel">
                <div class="input-group">
                    <label>Network Interface</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="interface_name" value="{{ data.interface }}" class="disabled">
                        <button id="scan-btn" class="scan-btn" onclick="runNetworkScan()">SCAN</button>
                    </div>
                </div>

                <datalist id="scanned-hosts"></datalist>

                <div class="input-group">
                    <label>Target IP</label>
                    <div class="input-wrapper">
                        <input type="text" id="target_ip" placeholder="Target IP..." onfocus="showDropdown(this)" onblur="hideDropdown(this)">
                        <div class="custom-dropdown" id="dropdown-target_ip"></div>
                    </div>
                </div>
                <div class="input-group">
                    <label>Gateway IP</label>
                    <div class="input-wrapper">
                        <input type="text" id="gateway_ip" placeholder="Gateway IP..." onfocus="showDropdown(this)" onblur="hideDropdown(this)">
                        <div class="custom-dropdown" id="dropdown-gateway_ip"></div>
                    </div>
                </div>

                <div id="dns-content" class="hidden">
                    <div class="divider"></div>
                    <label style="color: #4cff79; margin-bottom: 8px; display:block;">DNS CONFIGURATION</label>
                    <div class="input-group">
                        <label>Target Domain</label>
                        <input type="text" id="dns_domain" placeholder="e.g. www.example.com">
                    </div>
                    <div class="input-group">
                        <label>Redirect IP (Fake Server)</label>
                        <div class="input-wrapper">
                            <input type="text" id="dns_redirect" placeholder="Select Server IP..." autocomplete="off" onfocus="showDropdown(this)" onblur="hideDropdown(this)">
                            <div class="custom-dropdown" id="dropdown-dns_redirect"></div>
                        </div>
                    </div>
                    <button id="launch-btn-dns" class="btn start" onclick="toggleAttack()" style="margin-top: 25px;">LAUNCH DNS ATTACK</button>
                </div>

                <div id="ssl-content" class="hidden">
                    <div class="divider"></div>
                    <label style="color: #ff8c42; margin-bottom: 8px; display:block;">SSL STRIP INFO</label>
                    <div class="info-text">
                        Actively attempts to downgrade HTTPS connections to plain HTTP for interception.
                        <br><br>
                        <strong style="color:#ff4f4f">Warning:</strong> Noisy attack.
                    </div>
                    <button id="launch-btn-ssl" class="btn start" onclick="toggleAttack()" style="margin-top: 25px;">LAUNCH SSL STRIP</button>
                </div>

                <div id="silent-content" class="hidden">
                    <div class="divider"></div>
                    <label style="color: #aaa; margin-bottom: 8px; display:block;">PASSIVE MONITORING</label>
                    <div class="info-text" style="border-left: 3px solid #aaa;">
                        Runs in <strong>Stealth Mode</strong>.
                        <ul style="padding-left: 20px; margin: 5px 0;">
                            <li>No ARP Spoofing</li>
                            <li>No DNS Injection</li>
                            <li>Listens to Broadcasts Only</li>
                        </ul>
                    </div>
                    <button id="launch-btn-silent" class="btn start" onclick="toggleAttack()" style="margin-top: 25px; background: #555;">START MONITOR</button>
                </div>

            </div>
        </div>

        <div class="right-column">
            <div class="panel logs">
                <div class="metrics">
                    <div class="metric"><span class="metric-label">Packets</span><span class="metric-value" id="packet_count">0</span></div>
                    <div class="metric"><span class="metric-label">Mode</span><span class="metric-value" id="current_mode">NONE</span></div>
                    <div class="metric"><span class="metric-label">Target MAC</span><span class="metric-value" id="target_mac">N/A</span></div>
                </div>
                <div class="panel-header">
                    <h2>Console Output</h2>
                    <div class="window-controls">
                        <button class="win-btn collapse-btn" onclick="toggleConsole('console-output', this)" title="Collapse">▼</button>
                        <button class="win-btn clear-btn" onclick="clearConsole('console-output')" title="Clear Logs">×</button>
                    </div>
                </div>
                <div id="console-output" class="console">
                    </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h2 style="color: #ff8c42;">Sensitive Data</h2>
                    <div class="window-controls">
                        <button class="win-btn collapse-btn" onclick="toggleConsole('data_output', this)" title="Collapse">▼</button>
                        <button class="win-btn clear-btn" onclick="clearConsole('data_output')" title="Clear Logs">×</button>
                    </div>
                </div>
                <div id="data_output" class="console data-intercepts-console">
                    <div class="log-entry" style="opacity: 0.5;">Waiting for traffic...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="scan-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Network Scan Results</h3>
            <span class="close-btn" onclick="closeModal()">×</span>
        </div>
        <div id="scan-results" class="scan-list">
            <div style="padding:20px; text-align:center; color:#888;">Scanning...</div>
        </div>
    </div>
</div>

<script>
    let currentTab = 'dns';
    let isRunning = false;
    let scannedHosts = []; 
    let lastLogCount = 0;

    document.addEventListener('DOMContentLoaded', () => {
        loadState();

        // Initialize Console
        const consoleDiv = document.getElementById('console-output');
        if (consoleDiv.innerHTML.trim() === "") {
            consoleDiv.innerHTML = '<div class="log-entry">[SYSTEM] Ready. Scan network to begin.</div>';
        }

        // Default to DNS tab if none active
        if (document.querySelectorAll('.tab-btn.active').length === 0) {
            switchTab('dns', false);
        }

        // Auto-save on type
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', saveState);
        });

        // Sync with server
        fetch('/update').then(r => r.json()).then(data => {
            if (data.state === "RUNNING") {
                if (data.active_tab) switchTab(data.active_tab, false);
                const inputs = document.querySelectorAll('input:not(#interface_name)');
                inputs.forEach(i => i.disabled = true);
            }
            updateDashboard();
        });
    });

    // --- LOCAL STORAGE (Simplified for Global Inputs) ---
    function saveState() {
        const getVal = (id) => {
            const el = document.getElementById(id);
            return el ? el.value : '';
        };

        const state = {
            tab: currentTab,
            interface: getVal('interface_name'),
            
            // WE ONLY SAVE GLOBAL TARGETS NOW
            target_ip: getVal('target_ip'),
            gateway_ip: getVal('gateway_ip'),
            
            // Specific Attack Configs
            dns_domain: getVal('dns_domain'),
            dns_redirect: getVal('dns_redirect')
        };
        localStorage.setItem('mitm_config', JSON.stringify(state));
    }

    function loadState() {
        const saved = localStorage.getItem('mitm_config');
        if (!saved) return; 

        try {
            const state = JSON.parse(saved);
            
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if(el && val) el.value = val;
            };

            setVal('interface_name', state.interface);
            setVal('target_ip', state.target_ip);
            setVal('gateway_ip', state.gateway_ip);
            setVal('dns_domain', state.dns_domain);
            setVal('dns_redirect', state.dns_redirect);

            if (state.tab) switchTab(state.tab, false);

        } catch (e) {
            console.error("Failed to load state:", e);
        }
    }

    // --- CORE FUNCTIONS ---

    function switchTab(mode, shouldSave = true) {
        currentTab = mode;
        
        const tabs = document.querySelectorAll('.tab-btn');
        const dnsContent = document.getElementById('dns-content');
        const sslContent = document.getElementById('ssl-content');
        const silentContent = document.getElementById('silent-content');

        tabs.forEach(t => t.classList.remove('active'));
        dnsContent.classList.add('hidden');
        sslContent.classList.add('hidden');
        silentContent.classList.add('hidden');

        if (mode === 'dns') {
            tabs[0].classList.add('active');
            dnsContent.classList.remove('hidden');
        } else if (mode === 'ssl') {
            tabs[1].classList.add('active');
            sslContent.classList.remove('hidden');
        } else {
            tabs[2].classList.add('active');
            silentContent.classList.remove('hidden');
        }

        if (!isRunning && shouldSave) saveState();
    }

    function runNetworkScan() {
        saveState(); 
        const btn = document.getElementById('scan-btn');
        const iface = document.getElementById('interface_name').value;

        btn.innerText = "...";
        btn.disabled = true;
        btn.style.cursor = "wait";

        fetch('/scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ interface: iface })
        })
        .then(r => r.json())
        .then(data => {
            btn.innerText = "SCAN";
            btn.disabled = false;
            btn.style.cursor = "pointer";

            if(data.status === "success") {
                scannedHosts = data.hosts || [];
                if (scannedHosts.length === 0) {
                    alert("No hosts found."); return;
                }
                
                // Flash GLOBAL inputs
                flashInput('target_ip'); 
                flashInput('gateway_ip'); 
                flashInput('dns_redirect');
                
                console.log("Scan complete. Hosts cached.");
            } else {
                alert("Error: " + data.message);
            }
        });
    }

    function toggleAttack() {
        saveState(); 
        const iface = document.getElementById('interface_name').value;
        
        // --- KEY FIX: READ FROM GLOBAL INPUTS ---
        const target = document.getElementById('target_ip').value;
        const gateway = document.getElementById('gateway_ip').value;
        
        let dnsDomain = "", dnsIp = "", actionStr;

        if (currentTab === 'dns') {
            actionStr = 'start_dns';
            dnsDomain = document.getElementById('dns_domain').value;
            dnsIp = document.getElementById('dns_redirect').value; 
        } else if (currentTab === 'ssl') {
            actionStr = 'start_sslstrip';
        } else {
            actionStr = 'start_silent';
        }

        if(!target) { alert("Please enter a Target IP."); return; }
        if(!gateway) { alert("Please enter a Gateway IP."); return; }
        
        const finalAction = isRunning ? 'stop' : actionStr;
        const inputs = document.querySelectorAll('input:not(#interface_name)');
        inputs.forEach(i => i.disabled = !isRunning);

        fetch('/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                action: finalAction, 
                target: target, 
                gateway: gateway, 
                interface: iface,
                dns_domain: dnsDomain,
                dns_ip: dnsIp
            })
        }).then(() => setTimeout(updateDashboard, 500));
    }

    // --- UI HELPERS ---
    function showDropdown(inputElement) {
        if(scannedHosts.length === 0) return;
        const dropdownId = 'dropdown-' + inputElement.id;
        const dropdown = document.getElementById(dropdownId);
        if(!dropdown) return;

        dropdown.innerHTML = '';
        scannedHosts.forEach(host => {
            const ip = host.ip ? host.ip : host;
            const mac = host.mac ? host.mac : 'Unknown';
            const div = document.createElement('div');
            div.className = 'dropdown-item';
            div.innerHTML = `<span>${ip}</span><span class="mac">${mac}</span>`;
            div.onmousedown = function(e) {
                e.preventDefault(); 
                inputElement.value = ip;
                dropdown.classList.remove('show');
                saveState(); 
            };
            dropdown.appendChild(div);
        });
        dropdown.classList.add('show');
    }

    function hideDropdown(inputElement) {
        setTimeout(() => {
            const dropdownId = 'dropdown-' + inputElement.id;
            const dropdown = document.getElementById(dropdownId);
            if(dropdown) dropdown.classList.remove('show');
            saveState(); 
        }, 200);
    }

    function flashInput(id) {
        const el = document.getElementById(id);
        if(el) {
            el.classList.remove('input-flash');
            void el.offsetWidth;
            el.classList.add('input-flash');
        }
    }

    function closeModal() { document.getElementById('scan-modal').style.display = "none"; }
    window.onclick = function(event) { if (event.target == document.getElementById('scan-modal')) closeModal(); }

    function updateDashboard() {
        fetch('/update').then(r => r.json()).then(data => {
            document.getElementById('packet_count').innerText = data.packets;
            document.getElementById('current_mode').innerText = data.mode;
            document.getElementById('target_mac').innerText = data.target_mac;

            const wasRunning = isRunning;
            isRunning = (data.state === "RUNNING");
            
            // Sync with server if just loaded
            if (isRunning && !wasRunning) {
                if (data.active_tab) switchTab(data.active_tab, false);
            }

            const btnDns = document.getElementById('launch-btn-dns');
            const btnSsl = document.getElementById('launch-btn-ssl');
            const btnSilent = document.getElementById('launch-btn-silent');
            
            let activeBtn;
            if (currentTab === 'dns') activeBtn = btnDns;
            else if (currentTab === 'ssl') activeBtn = btnSsl;
            else activeBtn = btnSilent;

            if (isRunning) {
                if(activeBtn) {
                    activeBtn.innerText = "STOP ATTACK";
                    activeBtn.className = "btn stop";
                }
                document.querySelectorAll('.tab-btn').forEach(t => t.style.pointerEvents = "none");
            } else {
                if(btnDns) { btnDns.innerText = "LAUNCH DNS ATTACK"; btnDns.className = "btn start"; }
                if(btnSsl) { btnSsl.innerText = "LAUNCH SSL STRIP"; btnSsl.className = "btn start"; }
                if(btnSilent) { 
                    btnSilent.innerText = "START MONITOR"; 
                    btnSilent.className = "btn start"; 
                    btnSilent.style.background = "#555"; 
                }
                document.querySelectorAll('.tab-btn').forEach(t => t.style.pointerEvents = "all");
                const inputs = document.querySelectorAll('input:not(#interface_name)');
                inputs.forEach(i => i.disabled = false);
            }

            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');
            statusText.innerText = data.state;
            statusText.className = "status-text " + data.state.toLowerCase();
            statusDot.className = "status-dot " + data.state.toLowerCase();

            // Logs
            if (data.logs.length !== lastLogCount) {
                lastLogCount = data.logs.length;
                const consoleDiv = document.getElementById('console-output');
                consoleDiv.innerHTML = "";
                
                if (data.logs.length === 0) {
                    const div = document.createElement('div');
                    div.className = "log-entry";
                    div.innerText = "[SYSTEM] Ready. Scan network to begin.";
                    consoleDiv.appendChild(div);
                }

                data.logs.slice().reverse().forEach(log => {
                    const div = document.createElement('div');
                    div.className = "log-entry";
                    if (log.includes("SUCCESS") || log.includes("RESOLVED")) div.classList.add("success");
                    if (log.includes("WARNING") || log.includes("unreachable")) div.classList.add("warning");
                    if (log.includes("ERROR") || log.includes("FATAL")) div.classList.add("error");
                    div.innerText = log;
                    consoleDiv.appendChild(div);
                });
            }
            
            // Intercepts
            const dataDiv = document.getElementById('data_output');
            dataDiv.innerHTML = "";
            if (data.intercepted_data.length > 0) {
                data.intercepted_data.slice().reverse().forEach(item => {
                    let color = item.type === "ALERT" ? "#ff4f4f" : "#ff8c42";
                    const div = document.createElement('div');
                    div.className = "log-entry intercept-entry";
                    div.style.borderLeft = `3px solid ${color}`;
                    div.innerHTML = `
                        <div style="font-size:11px; color:#555; display:flex; justify-content:space-between;">
                            <span>[${item.time}] ${item.src} &rarr; ${item.dst}</span>
                            <a href="/view/${item.id || ''}" target="_blank" style="color:${color}; font-weight:bold; text-decoration:none;">VIEW</a>
                        </div>
                        <div style="color:#e3e3e3; margin-top:2px; font-family:monospace; word-break:break-all;">${item.snippet}</div>
                    `;
                    dataDiv.appendChild(div);
                });
            } else {
                dataDiv.innerHTML = '<div class="log-entry" style="opacity:0.5">Waiting for traffic...</div>';
            }
        });
    }

    function clearConsole(target) {
        const actionType = (target === 'console-output') ? 'clear_logs' : 'clear_data';
        if(target === 'console-output') lastLogCount = -1;
        fetch('/action', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ action: actionType })
        });
    }

    function toggleConsole(id, btn) {
        const consoleDiv = document.getElementById(id);
        const isCollapsed = consoleDiv.classList.toggle('collapsed');
        btn.style.transform = isCollapsed ? "rotate(-90deg)" : "rotate(0deg)";
    }
    
    setInterval(updateDashboard, 1000);
</script>
</body>
</html>